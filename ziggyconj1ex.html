<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spanish Learning Activity: Key Question Phrases</title>
    <style>
        /* Scope all styles to our container */
        .spanish-learning-container {
            /* ... Standard CSS Variables ... */
            --primary-color: #F2CB05;
            --secondary-color: #00994D;
            --accent-color: #C72C27;
            --text-color: #333;
            --background-color: #f9f9f9;
            --alt-background-color: #fff;
            --font-family: 'Arial', sans-serif;
            --highlight-color: rgba(242, 203, 5, 0.2);
            --ziggy-highlight: #FFDAB9;
            --success-color: #4CAF50;
            --error-color: #f44336;

            font-family: var(--font-family);
            color: var(--text-color);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            max-width: 700px; /* Consistent width */
            margin: 20px auto;
            width: 100%;
            position: relative;
            box-sizing: border-box;
            background-color: transparent;
        }

        .spanish-learning-container * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* Activity Section Styles */
        .spanish-learning-container .activity-section {
            margin-bottom: 20px;
            background-color: var(--alt-background-color); /* White sections */
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #eee; /* Subtle border */
        }

        .spanish-learning-container .activity-section h2 {
            color: var(--secondary-color); /* Green heading */
            border-bottom: 2px solid var(--primary-color); /* Yellow underline */
            padding-bottom: 5px;
            margin-bottom: 15px;
            font-size: 1.3rem; /* Slightly smaller heading */
        }
         .spanish-learning-container .activity-section p,
         .spanish-learning-container .activity-section ol,
         .spanish-learning-container .activity-section ul { /* Added ul */
             line-height: 1.6;
             margin-bottom: 10px;
         }
         .spanish-learning-container .activity-section ol,
         .spanish-learning-container .activity-section ul { /* Added ul */
            padding-left: 25px;
         }
          /* Styling for phrase list */
          .spanish-learning-container .phrase-list {
             list-style-type: lower-roman; /* i, ii, iii... */
             margin-top: 5px;
             margin-bottom: 15px; /* Space before button */
          }
           .spanish-learning-container .phrase-list li {
               margin-bottom: 5px;
               font-style: italic;
               color: #444;
           }
         .spanish-learning-container .instruction-text {
            font-style: italic;
            color: #555;
            margin-bottom: 15px !important;
         }

        /* --- Verb/Emoji Drag and Drop Styles --- */
        .spanish-learning-container .verb-drag-drop-container {
            display: flex; flex-direction: column; gap: 20px; padding: 15px;
            min-height: 200px; background-color: #f5f5f5; border-radius: 5px;
        }
        .spanish-learning-container .verb-drop-zones-container,
        .spanish-learning-container .verb-drag-items-container {
            display: grid; grid-template-columns: repeat(3, minmax(100px, 1fr));
            gap: 15px; justify-content: center;
        }
        .spanish-learning-container .verb-drag-item {
            background: var(--alt-background-color); padding: 10px; border: 1px dashed #ccc; border-radius: 5px;
            cursor: grab; user-select: none; display: flex; align-items: center; justify-content: center;
            min-height: 45px; text-align: center; touch-action: none; font-weight: bold; font-size: 1rem;
            transition: background-color 0.2s;
        }
        .spanish-learning-container .verb-drag-item:active { cursor: grabbing; background-color: #eee; }
        .spanish-learning-container .verb-drop-zone {
            border: 2px solid #ddd; background: #fff; border-radius: 5px; min-height: 45px;
            display: flex; align-items: center; justify-content: center; font-size: 1.8rem;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .spanish-learning-container .verb-drop-zone.correct { background: #e0ffe0; border-color: var(--success-color); }
        .spanish-learning-container .verb-drop-zone.incorrect { background: #ffe0e0; border-color: var(--error-color); }
        .spanish-learning-container .verb-drop-zone.filled { font-size: 1rem; font-weight: bold; color: var(--text-color); }
        /* --- End Verb Drag/Drop Styles --- */

        /* --- Phrase Matching Drag and Drop Styles --- */
        .spanish-learning-container .phrase-drag-drop-container {
            display: flex; flex-direction: column; gap: 25px; padding: 15px;
            min-height: 300px; background-color: #f5f5f5; border-radius: 5px;
            margin-top: 15px;
        }
        .spanish-learning-container .phrase-drop-zones-container,
        .spanish-learning-container .phrase-drag-items-container {
            display: grid; grid-template-columns: 1fr; gap: 10px; justify-content: center;
        }
        .spanish-learning-container .phrase-drag-item {
            background: var(--alt-background-color); padding: 12px 15px; border: 1px dashed #ccc; border-radius: 5px;
            cursor: grab; user-select: none; display: flex; align-items: center; justify-content: center;
            min-height: 45px; text-align: center; touch-action: none; font-weight: normal; font-size: 1rem; font-style: italic;
            transition: background-color 0.2s;
        }
        .spanish-learning-container .phrase-drag-item:active { cursor: grabbing; background-color: #eee; }
        .spanish-learning-container .phrase-drop-zone {
            border: 2px solid #ddd; background: #fff; border-radius: 5px; min-height: 50px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 10px; transition: background-color 0.3s, border-color 0.3s; text-align: center;
        }
        .spanish-learning-container .phrase-drop-zone .english-phrase { font-weight: bold; margin-bottom: 8px; color: #555; }
        .spanish-learning-container .phrase-drop-zone.correct { background: #e0ffe0; border-color: var(--success-color); }
        .spanish-learning-container .phrase-drop-zone.incorrect { background: #ffe0e0; border-color: var(--error-color); }
        .spanish-learning-container .phrase-drop-zone .dropped-phrase { font-size: 1rem; font-style: italic; color: var(--text-color); background-color: var(--highlight-color); padding: 5px 8px; border-radius: 3px; }
         /* --- End Phrase Drag/Drop Styles --- */

        /* --- Warmup Step Control --- */
        .hidden { display: none; }
        /* --- End Warmup Step Control --- */

        /* Ziggy Section Styles */
        .spanish-learning-container .ziggy-section { margin-top: 20px; padding: 15px; background-color: var(--alt-background-color); border-radius: 5px; border: 1px solid #eee; }
        .spanish-learning-container .ziggy-section h3 { color: var(--secondary-color); margin-bottom: 15px; }
        .spanish-learning-container .ziggy-highlight-text { background-color: var(--ziggy-highlight); padding: 3px 6px; border-radius: 3px; font-weight: bold; color: #444; display: inline-block; }
        .spanish-learning-container .ziggy-section ul { list-style: none; padding: 0; }
        .spanish-learning-container .ziggy-section li { margin-bottom: 10px; background-color: #f8f8f8; padding: 8px 12px; border-radius: 4px; font-size: 0.95rem; }
        .spanish-learning-container .ziggy-section li::before { content: "ü§ñ"; margin-right: 8px; font-size: 1.1em; }

        /* Button Styles */
        .spanish-learning-container .action-button {
            background-color: var(--secondary-color); color: white; border: none; padding: 8px 15px;
            border-radius: 5px; cursor: pointer; transition: background-color 0.3s, transform 0.1s;
            font-weight: bold; white-space: nowrap; flex-shrink: 0;
        }
        .spanish-learning-container .action-button:disabled { background-color: #ccc; cursor: not-allowed; }
        .spanish-learning-container .action-button:hover:not(:disabled) { background-color: #007a3d; opacity: 0.95; }
        .spanish-learning-container .action-button:active:not(:disabled) { transform: scale(0.98); }
        .spanish-learning-container .reset-button { background-color: #6c757d; }
        .spanish-learning-container .reset-button:hover:not(:disabled) { background-color: #5a6268; }
        .spanish-learning-container .meanings-button { /* Style specifically for meanings button */
            background-color: var(--primary-color);
            color: var(--text-color);
        }
        .spanish-learning-container .meanings-button:hover:not(:disabled) {
             background-color: #e0b804;
         }
        .spanish-learning-container .start-matching-button {
             margin-top: 10px; display: block; margin-left: auto; margin-right: auto;
         }

         /* --- Meanings Overlay Styles --- */
         .meanings-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); z-index: 1000; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s ease-in-out;
        }
        .meanings-overlay.show { display: flex; opacity: 1; }
        .meanings-content {
            background-color: white; padding: 25px; border-radius: 8px; max-width: 450px; width: 90%;
            position: relative; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transform: scale(0.95); transition: transform 0.3s ease-in-out;
        }
        .meanings-overlay.show .meanings-content { transform: scale(1); }
        .meanings-content h3 { color: var(--secondary-color); margin-bottom: 15px; text-align: center; font-size: 1.4rem; }
        .meanings-list { list-style: none; padding: 0; margin: 0 0 20px 0; column-count: 2; column-gap: 20px; }
        .meanings-list li { padding: 8px 0; border-bottom: 1px solid #eee; font-size: 1.0em; display: flex; align-items: center; gap: 8px; break-inside: avoid; }
        .meanings-list li .emoji { font-size: 1.2em; }
        .meanings-list li:last-child { border-bottom: none; }
        .close-meanings { display: block; width: 100%; margin-top: 15px; }
        /* --- End Meanings Overlay --- */

        /* Responsive Styles */
        @media (max-width: 600px) {
            .spanish-learning-container { padding: 10px; margin: 10px; }
             .verb-drop-zones-container, .verb-drag-items-container { grid-template-columns: repeat(2, 1fr); }
             .verb-drag-item { font-size: 0.85rem; }
             .verb-drop-zone.filled { font-size: 0.85rem; }
            .phrase-drop-zones-container, .phrase-drag-items-container { grid-template-columns: 1fr; }
            .phrase-drag-item, .phrase-drop-zone { font-size: 0.95rem; }
            .phrase-drop-zone .english-phrase { font-size: 0.9rem;}
            .phrase-drop-zone .dropped-phrase { font-size: 0.95rem; }
             .meanings-list { column-count: 1; }
        }

    </style>
</head>
<body>
<div class="spanish-learning-container" id="spanishLearning">
    <div class="activity-section">
        <h2>üéØ Goal</h2>
        <p>Master key question phrases and structures in Spanish!</p>
        <p>
            <strong>Today's Key Phrases/Verbs:</strong><br>
             üîç Qu√© | ‚ùì Por qu√© | üí∞ Cu√°nto | üôè Podr√≠as | üì¢ Explicarlo | üëâ Referirse
        </p>
    </div>

     <!-- Section 1: Verb/Keyword Review -->
     <div class="activity-section">
        <h2>1. üìã Review: Match Concepts to Emojis</h2>
        <p>Drag and drop each Spanish concept/verb keyword to its corresponding emoji.</p>
        <div class="verb-drag-drop-container" id="verbDragDropArea">
             <!-- Verb Drag/Drop zones & items will be generated here by JS -->
        </div>
        <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
            <button class="action-button reset-button" onclick="resetActivity()">Reset Review</button>
            <!-- ADDED Show Meanings Button -->
            <button class="action-button meanings-button" onclick="showMeanings()">Show Meanings</button>
        </div>
    </div>

     <!-- ADDED Meanings Overlay -->
     <div id="meaningsOverlay" class="meanings-overlay">
        <div class="meanings-content">
            <h3>Keyword Meanings</h3>
            <ul class="meanings-list" id="verbMeaningsList">
                <!-- Meanings will be populated by JS -->
            </ul>
            <button onclick="hideMeanings()" class="action-button close-meanings">Close</button>
        </div>
    </div>

    <!-- Section 2: Phrase Matching Warm-up -->
    <div class="activity-section">
        <h2>2. üìù Warm-up: Reading & Matching Phrases</h2>
        <ol type="a">
            <li>Read each Spanish phrase below carefully.</li>
            <li>Click the button below when you are ready to match them to their English meanings.</li>
        </ol>

        <div id="phraseReadingArea"> <!-- Wrapper for initial display -->
            <h4>Spanish Phrases:</h4>
            <ul class="phrase-list">
                 <li>¬øPodr√≠as explicarlo de otra manera?</li>
                 <li>¬øA qu√© te refieres con "inseguridad alimentaria"?</li>
                 <li>¬øPor qu√© sucedi√≥ eso?</li>
                 <li>¬øCu√°nto tiempo dur√≥ esa situaci√≥n?</li>
                 <li>¬øQu√© hizo el gobierno para ayudar?</li>
             </ul>
            <button id="startMatchingBtn" class="action-button start-matching-button" onclick="startMatching()">I've read the phrases, start matching!</button>
        </div>

        <div class="phrase-drag-drop-container hidden" id="phraseDragDropArea"> <!-- Initially hidden -->
              <h4>Drag the Spanish phrases to the correct English meaning:</h4>
             <!-- Phrase Drag/Drop zones & items will be generated here by JS when button clicked -->
        </div>
        <div id="phraseResetBtnContainer" class="hidden" style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;"> <!-- Initially hidden -->
            <button class="action-button reset-button" onclick="resetActivity()">Reset Matching</button>
        </div>
    </div>


    <div class="activity-section ziggy-section">
        <h3>3. ü§ñ Check with Ziggy</h3>
        <p>Type in your translations and ask Ziggy to check them.</p>
        <ul>
            <li>Ask Ziggy: Does <span class="ziggy-highlight-text">¬øPodr√≠as explicarlo de otra manera?</span> mean Could you explain it differently?</li>
            <!-- Add other specific checks or general prompts as desired -->
        </ul>
    </div>
</div>

<script>
    // === Configuration ===
     const reviewVerbs = [
        { verb: 'Qu√©', emoji: 'üîç', meaning: 'What' },
        { verb: 'Por qu√©', emoji: '‚ùì', meaning: 'Why' },
        { verb: 'Cu√°nto', emoji: 'üí∞', meaning: 'How much/many' },
        { verb: 'Podr√≠as', emoji: 'üôè', meaning: 'Could you (informal)' },
        { verb: 'Explicarlo', emoji: 'üì¢', meaning: 'Explain it' },
        { verb: 'Referirse', emoji: 'üëâ', meaning: 'To refer to' }
    ];
    const phrases = [
        { spanish: '¬øPodr√≠as explicarlo de otra manera?', english: 'Could you explain it differently?', id: 'phrase1' },
        { spanish: '¬øA qu√© te refieres con "inseguridad alimentaria"?', english: 'What do you mean by "food insecurity"?', id: 'phrase2' },
        { spanish: '¬øPor qu√© sucedi√≥ eso?', english: 'Why did that happen?', id: 'phrase3' },
        { spanish: '¬øCu√°nto tiempo dur√≥ esa situaci√≥n?', english: 'How long did that situation last?', id: 'phrase4' },
        { spanish: '¬øQu√© hizo el gobierno para ayudar?', english: 'What did the government do to help?', id: 'phrase5' }
    ];

    // === State Variables ===
    let draggedItem = null;
    let touchStartX = 0;
    let touchStartY = 0;
    let currentDroppable = null;

    // === DOM Elements ===
    const verbDragDropArea = document.getElementById('verbDragDropArea');
    const phraseDragDropArea = document.getElementById('phraseDragDropArea');
    const phraseReadingArea = document.getElementById('phraseReadingArea');
    const startMatchingBtn = document.getElementById('startMatchingBtn');
    const phraseResetBtnContainer = document.getElementById('phraseResetBtnContainer');
    const meaningsOverlay = document.getElementById('meaningsOverlay'); // Get overlay
    const verbMeaningsList = document.getElementById('verbMeaningsList'); // Get list inside overlay

    // === Utility Functions ===
    function shuffleArray(array) {
        const shuffled = [...array];
        for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        return shuffled;
    }

    function normalizeString(str) {
         return str.trim();
    }

    // === Drag and Drop Logic ===

    // --- Initialize BOTH drag-drop areas ---
    function initializeAllDragDrop() {
        initializeVerbDragDrop();
        // Phrase Drag/Drop is initialized only after button click
    }

    // --- Verb/Emoji Drag Drop ---
    function initializeVerbDragDrop() {
        verbDragDropArea.innerHTML = '';
        if (!reviewVerbs || reviewVerbs.length === 0) return;

        const shuffledVerbsForDrag = shuffleArray(reviewVerbs);
        const shuffledVerbsForDrop = shuffleArray(reviewVerbs);

        const dropZonesContainer = document.createElement('div');
        dropZonesContainer.className = 'verb-drop-zones-container';
        const dragItemsContainer = document.createElement('div');
        dragItemsContainer.className = 'verb-drag-items-container';

        verbDragDropArea.appendChild(dropZonesContainer);
        verbDragDropArea.appendChild(dragItemsContainer);

        shuffledVerbsForDrop.forEach(item => {
            const dropZone = document.createElement('div');
            dropZone.className = 'verb-drop-zone';
            dropZone.dataset.verb = item.verb;
            dropZone.textContent = item.emoji;
            dropZone.setAttribute('aria-label', `Drop zone for ${item.verb}`);
            dropZone.setAttribute('role', 'region');
            dropZonesContainer.appendChild(dropZone);
            addDropZoneListeners(dropZone);
        });

        shuffledVerbsForDrag.forEach(item => {
            const dragItem = document.createElement('div');
            dragItem.className = 'verb-drag-item';
            dragItem.draggable = true;
            dragItem.textContent = item.verb;
            dragItem.dataset.verb = item.verb;
            dragItem.setAttribute('aria-label', `Draggable keyword: ${item.verb}`);
            dragItemsContainer.appendChild(dragItem);
            addDragItemListeners(dragItem);
        });
    }

     // --- Phrase Matching Drag Drop ---
     function initializePhraseDragDrop() {
        phraseDragDropArea.innerHTML = '';
        if (!phrases || phrases.length === 0) return;

        const shuffledPhrasesForDrag = shuffleArray(phrases);
        const shuffledPhrasesForDrop = shuffleArray(phrases);

        const dropZonesContainer = document.createElement('div');
        dropZonesContainer.className = 'phrase-drop-zones-container';
        const dragItemsContainer = document.createElement('div');
        dragItemsContainer.className = 'phrase-drag-items-container';

        phraseDragDropArea.appendChild(dropZonesContainer);
        phraseDragDropArea.appendChild(dragItemsContainer);

        shuffledPhrasesForDrop.forEach(item => {
            const dropZone = document.createElement('div');
            dropZone.className = 'phrase-drop-zone';
            dropZone.dataset.id = item.id;
            dropZone.innerHTML = `<span class="english-phrase">${item.english}</span>`;
            dropZone.setAttribute('aria-label', `Drop zone for: ${item.english}`);
            dropZone.setAttribute('role', 'region');
            dropZonesContainer.appendChild(dropZone);
            addDropZoneListeners(dropZone);
        });

        shuffledPhrasesForDrag.forEach(item => {
            const dragItem = document.createElement('div');
            dragItem.className = 'phrase-drag-item';
            dragItem.draggable = true;
            dragItem.textContent = item.spanish;
            dragItem.dataset.id = item.id;
            dragItem.setAttribute('aria-label', `Draggable phrase: ${item.spanish}`);
            dragItemsContainer.appendChild(dragItem);
            addDragItemListeners(dragItem);
        });
    }

    // --- Start Matching Function ---
    function startMatching() {
        phraseReadingArea.classList.add('hidden');
        phraseDragDropArea.classList.remove('hidden');
        phraseResetBtnContainer.classList.remove('hidden');
        initializePhraseDragDrop();
    }


    // --- Generic Event Handlers ---
     function addDragItemListeners(item) {
        item.addEventListener('dragstart', handleDragStart);
        item.addEventListener('dragend', handleDragEnd);
        item.addEventListener('touchstart', handleTouchStart, { passive: false });
        item.addEventListener('touchmove', handleTouchMove, { passive: false });
        item.addEventListener('touchend', handleTouchEnd);
    }

     function addDropZoneListeners(zone) {
        zone.addEventListener('dragover', handleDragOver);
        zone.addEventListener('dragleave', handleDragLeave);
        zone.addEventListener('drop', handleDrop);
    }


    function handleDragStart(e) {
        draggedItem = e.target;
        let dataValue = '';
        if(e.target.classList.contains('verb-drag-item')) {
            dataValue = e.target.dataset.verb;
        } else if (e.target.classList.contains('phrase-drag-item')) {
            dataValue = e.target.dataset.id;
        }
        if (e.dataTransfer) {
            e.dataTransfer.setData('text/plain', dataValue);
            e.dataTransfer.effectAllowed = 'move';
        }
        setTimeout(() => {if(draggedItem) draggedItem.style.opacity = '0.5'}, 0);
    }

    function handleDragEnd(e) {
        if (draggedItem) {
             draggedItem.style.opacity = '1';
        }
        draggedItem = null;
        document.querySelectorAll('.verb-drop-zone.over, .phrase-drop-zone.over').forEach(zone => zone.classList.remove('over'));
    }

    function handleDragOver(e) {
        e.preventDefault();
         if (e.dataTransfer) {
            e.dataTransfer.dropEffect = 'move';
         }
         const dropZone = e.target.closest('.verb-drop-zone, .phrase-drop-zone');
         if (dropZone && draggedItem) {
             const isVerbItem = draggedItem.classList.contains('verb-drag-item');
             const isVerbZone = dropZone.classList.contains('verb-drop-zone');
             const isPhraseItem = draggedItem.classList.contains('phrase-drag-item');
             const isPhraseZone = dropZone.classList.contains('phrase-drop-zone');

             if ((isVerbItem && isVerbZone && !dropZone.classList.contains('filled')) ||
                 (isPhraseItem && isPhraseZone && !dropZone.querySelector('.dropped-phrase'))) {
                 dropZone.classList.add('over');
             }
         }
    }

     function handleDragLeave(e) {
         e.target.closest('.verb-drop-zone, .phrase-drop-zone')?.classList.remove('over');
     }

    function handleDrop(e) {
        e.preventDefault();
        const dropZone = e.target.closest('.verb-drop-zone, .phrase-drop-zone');
        if (!dropZone || !draggedItem) return;

        dropZone.classList.remove('over');

        // Handle Verb Drop
        if (dropZone.classList.contains('verb-drop-zone') && draggedItem.classList.contains('verb-drag-item')) {
            if (dropZone.classList.contains('filled')) return;
            const draggedVerb = draggedItem.dataset.verb;
            const targetVerb = dropZone.dataset.verb;

            if (draggedVerb === targetVerb) {
                dropZone.textContent = draggedItem.textContent;
                dropZone.className = 'verb-drop-zone correct filled';
                draggedItem.remove();
            } else {
                dropZone.classList.add('incorrect');
                setTimeout(() => dropZone.classList.remove('incorrect'), 800);
            }
        }
        // Handle Phrase Drop
        else if (dropZone.classList.contains('phrase-drop-zone') && draggedItem.classList.contains('phrase-drag-item')) {
            if (dropZone.querySelector('.dropped-phrase')) return;
            const draggedId = draggedItem.dataset.id;
            const targetId = dropZone.dataset.id;

            if (draggedId === targetId) {
                 const droppedPhraseSpan = document.createElement('span');
                 droppedPhraseSpan.className = 'dropped-phrase';
                 droppedPhraseSpan.textContent = draggedItem.textContent;
                 dropZone.appendChild(droppedPhraseSpan);
                 dropZone.classList.add('correct');
                 draggedItem.remove();
            } else {
                dropZone.classList.add('incorrect');
                setTimeout(() => dropZone.classList.remove('incorrect'), 800);
            }
        }
    }

    // --- Touch Event Handlers ---
     function handleTouchStart(e) {
         if (e.target.classList.contains('verb-drag-item') || e.target.classList.contains('phrase-drag-item')) {
             e.preventDefault();
             draggedItem = e.target;
             const touch = e.touches[0];
             touchStartX = touch.clientX;
             touchStartY = touch.clientY;

             const clone = draggedItem.cloneNode(true);
             clone.style.position = 'absolute';
             clone.style.zIndex = '1000';
             clone.style.opacity = '0.7';
             clone.style.pointerEvents = 'none';
             document.body.appendChild(clone);
             draggedItem.clone = clone;

             clone.style.left = touch.clientX - clone.offsetWidth / 2 + 'px';
             clone.style.top = touch.clientY - clone.offsetHeight / 2 + 'px';

             draggedItem.style.opacity = '0.5';
         }
     }

     function handleTouchMove(e) {
         if (!draggedItem || !draggedItem.clone) return;
         e.preventDefault();

         const touch = e.touches[0];
         const clone = draggedItem.clone;

         clone.style.left = touch.clientX - clone.offsetWidth / 2 + 'px';
         clone.style.top = touch.clientY - clone.offsetHeight / 2 + 'px';

         clone.style.display = 'none';
         const elementUnderFinger = document.elementFromPoint(touch.clientX, touch.clientY);
         clone.style.display = '';

         const droppableBelow = elementUnderFinger?.closest('.verb-drop-zone, .phrase-drop-zone');

         if (currentDroppable !== droppableBelow) {
             currentDroppable?.classList.remove('over');
             if (droppableBelow && draggedItem) {
                  const isVerbItem = draggedItem.classList.contains('verb-drag-item');
                  const isVerbZone = droppableBelow.classList.contains('verb-drop-zone');
                  const isPhraseItem = draggedItem.classList.contains('phrase-drag-item');
                  const isPhraseZone = droppableBelow.classList.contains('phrase-drop-zone');

                  if (isVerbItem && isVerbZone && !droppableBelow.classList.contains('filled')) {
                       droppableBelow.classList.add('over');
                  } else if (isPhraseItem && isPhraseZone && !droppableBelow.querySelector('.dropped-phrase')) {
                       droppableBelow.classList.add('over');
                  } else {
                       droppableBelow = null; // Incompatible drop
                  }
             } else {
                  droppableBelow = null; // No valid zone
             }
             currentDroppable = droppableBelow;
         }
     }

     function handleTouchEnd(e) {
         if (!draggedItem || !draggedItem.clone) return;

         const clone = draggedItem.clone;
         document.body.removeChild(clone);
         draggedItem.clone = null;
         draggedItem.style.opacity = '1';

         const dropZone = currentDroppable;
         currentDroppable?.classList.remove('over');

         if (dropZone) {
             if (dropZone.classList.contains('verb-drop-zone') && draggedItem.classList.contains('verb-drag-item')) {
                 if (!dropZone.classList.contains('filled')) {
                     const draggedVerb = draggedItem.dataset.verb;
                     const targetVerb = dropZone.dataset.verb;
                     if (draggedVerb === targetVerb) {
                         dropZone.textContent = draggedItem.textContent;
                         dropZone.className = 'verb-drop-zone correct filled';
                         draggedItem.remove();
                     } else {
                         dropZone.classList.add('incorrect');
                         setTimeout(() => { dropZone.classList.remove('incorrect'); }, 800);
                     }
                 }
             }
             else if (dropZone.classList.contains('phrase-drop-zone') && draggedItem.classList.contains('phrase-drag-item')) {
                 if (!dropZone.querySelector('.dropped-phrase')) {
                     const draggedId = draggedItem.dataset.id;
                     const targetId = dropZone.dataset.id;
                     if (draggedId === targetId) {
                         const droppedPhraseSpan = document.createElement('span');
                         droppedPhraseSpan.className = 'dropped-phrase';
                         droppedPhraseSpan.textContent = draggedItem.textContent;
                         dropZone.appendChild(droppedPhraseSpan);
                         dropZone.classList.add('correct');
                         draggedItem.remove();
                     } else {
                         dropZone.classList.add('incorrect');
                         setTimeout(() => { dropZone.classList.remove('incorrect'); }, 800);
                     }
                 }
             }
         }

         draggedItem = null;
         currentDroppable = null;
     }


    function resetActivity() {
        // Reset both drag-drop areas
        initializeVerbDragDrop();
        // Reset phrase matching area to initial state
        phraseDragDropArea.innerHTML = ''; // Clear it
        phraseDragDropArea.classList.add('hidden');
        phraseReadingArea.classList.remove('hidden'); // Show reading area again
        phraseResetBtnContainer.classList.add('hidden'); // Hide reset button
    }

    // === Meanings Overlay Logic ===
    function populateVerbMeanings() {
         verbMeaningsList.innerHTML = ''; // Clear previous
         reviewVerbs.forEach(item => {
             const li = document.createElement('li');
             li.innerHTML = `<span class="emoji">${item.emoji}</span> ${item.verb} - ${item.meaning}`;
             verbMeaningsList.appendChild(li);
         });
    }
    function showMeanings() {
        populateVerbMeanings(); // Populate before showing
        meaningsOverlay.classList.add('show');
    }
    function hideMeanings() {
        meaningsOverlay.classList.remove('show');
    }

    // === Initialization ===
    document.addEventListener('DOMContentLoaded', () => {
        initializeVerbDragDrop(); // Initialize verb drag/drop on load
        // Phrase matching is initialized on button click

         // Close overlay event listeners
         meaningsOverlay.addEventListener('click', (e) => {
            if (e.target === meaningsOverlay) { // Check if click is on the overlay itself
                hideMeanings();
            }
        });
         document.addEventListener('keydown', (e) => {
             if (e.key === 'Escape' && meaningsOverlay.classList.contains('show')) {
                 hideMeanings();
             }
         });
    });

</script>
</body>
</html>
